<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kasir Pro - Google Sheets Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #fdfaf7; }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }

        .menu-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f5e6d3;
        }

        /* Styling Struk untuk Printer Thermal */
        #receipt-content {
            width: 300px;
            background: white;
            padding: 20px;
            font-family: 'Courier Prime', monospace;
            color: black;
            font-size: 12px;
            line-height: 1.4;
        }

        @media print {
            body * { visibility: hidden; }
            #receipt-modal-content, #receipt-modal-content * { visibility: visible; }
            #receipt-modal-content { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print-receipt { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="loader" class="loading-overlay">
        <div class="bg-white p-6 rounded-xl flex items-center gap-4 shadow-2xl">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#8b4513]"></div>
            <p class="font-bold text-[#3e1f0a]">Sinkronisasi Cloud...</p>
        </div>
    </div>

    <nav class="bg-[#5d2e0d] text-[#fdfaf7] p-4 shadow-lg no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="coffee"></i> TITIK HENING
            </h1>
            <div class="flex gap-2 md:gap-4">
                <button onclick="switchTab('kasir')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm md:text-base">Kasir</button>
                <button onclick="switchTab('admin')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm md:text-base">Menu</button>
                <button onclick="switchTab('laporan')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm md:text-base">Laporan</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6 mb-20 no-print">
        <div id="status-cloud" class="mb-4 text-center text-xs font-bold text-gray-500 bg-gray-100 py-1 rounded border border-gray-200 transition-colors">
            Status: Standalone Mode
        </div>

        <!-- TAB KASIR -->
        <div id="tab-kasir" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-[#3e1f0a]">Menu Pilihan</h2>
                    <div class="relative w-full md:w-1/3">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-[#8b4513]"></i>
                        <input type="text" id="search-menu" placeholder="Cari minuman..." class="border border-[#d2b48c] rounded-lg pl-10 pr-4 py-2 w-full outline-none focus:ring-2 focus:ring-[#8b4513] bg-white text-sm">
                    </div>
                </div>
                <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Keranjang -->
            <div class="bg-white p-6 rounded-xl shadow-md h-fit sticky top-6 border-t-4 border-[#8b4513]">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-[#3e1f0a]">
                    <i data-lucide="shopping-cart"></i> Daftar Pesanan
                </h2>
                <div id="cart-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-center py-4 italic text-sm">Belum ada pesanan</p>
                </div>
                <div class="border-t border-[#f5e6d3] pt-4">
                    <div class="flex justify-between text-lg font-bold">
                        <span class="text-[#3e1f0a]">Total Akhir:</span>
                        <span id="cart-total" class="text-[#8b4513]">Rp 0</span>
                    </div>
                    <button onclick="prosesPembayaran()" class="w-full bg-[#8b4513] hover:bg-[#5d2e0d] text-white font-bold py-3 rounded-lg mt-4 transition shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="save"></i> Bayar
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB ADMIN -->
        <div id="tab-admin" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto border-t-4 border-[#8b4513]">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <p class="text-xs text-yellow-700 font-bold">INFO DATABASE</p>
                    <input type="text" id="config-url" placeholder="URL Web App" class="w-full border border-yellow-200 p-2 rounded text-[10px] bg-white mt-1" onchange="saveConfig()">
                </div>
                
                <h2 id="form-title" class="text-2xl font-bold mb-6 text-[#3e1f0a]">Tambah Menu Baru</h2>
                <form id="menu-form" class="space-y-4">
                    <input type="hidden" id="menu-id">
                    <div>
                        <label class="block text-sm font-medium text-[#5d2e0d]">Nama Produk</label>
                        <input type="text" id="menu-nama" required class="w-full border border-[#d2b48c] rounded-lg px-4 py-2 mt-1 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-[#5d2e0d]">URL Foto Produk</label>
                        <input type="text" id="menu-foto" placeholder="https://..." class="w-full border border-[#d2b48c] rounded-lg px-4 py-2 mt-1 outline-none text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-[#fdfaf7] p-3 rounded-lg border border-[#d2b48c]">
                            <p class="font-bold text-xs text-[#8b4513] mb-2 uppercase">Varian Reguler</p>
                            <input type="number" id="menu-harga-reg" placeholder="Harga Jual" class="w-full border border-[#d2b48c] rounded px-2 py-1 mb-2 text-sm">
                            <input type="number" id="menu-hpp-reg" placeholder="HPP" class="w-full border border-[#d2b48c] rounded px-2 py-1 text-sm">
                        </div>
                        <div class="bg-[#fdfaf7] p-3 rounded-lg border border-[#d2b48c]">
                            <p class="font-bold text-xs text-[#8b4513] mb-2 uppercase">Varian 1 Liter</p>
                            <input type="number" id="menu-harga-1l" placeholder="Harga Jual" class="w-full border border-[#d2b48c] rounded px-2 py-1 mb-2 text-sm">
                            <input type="number" id="menu-hpp-1l" placeholder="HPP" class="w-full border border-[#d2b48c] rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="btn-submit-menu" class="flex-1 bg-[#8b4513] text-white py-2 rounded-lg font-bold">Simpan Produk</button>
                        <button type="button" id="btn-cancel-edit" onclick="resetMenuForm()" class="hidden bg-gray-200 text-gray-600 px-4 py-2 rounded-lg font-bold">Batal</button>
                    </div>
                </form>
                <div id="admin-menu-list" class="mt-8 space-y-2"></div>
            </div>
        </div>

        <!-- TAB LAPORAN -->
        <div id="tab-laporan" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 text-center md:text-left">
                    <p class="text-xs text-gray-500 font-bold">OMZET TOTAL</p>
                    <h3 id="summary-omzet" class="text-2xl font-bold">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500 text-center md:text-left">
                    <p class="text-xs text-gray-500 font-bold">MODAL TOTAL</p>
                    <h3 id="summary-modal" class="text-2xl font-bold">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 text-center md:text-left">
                    <p class="text-xs text-gray-500 font-bold">LABA TOTAL</p>
                    <h3 id="summary-laba" class="text-2xl font-bold text-green-700">Rp 0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-[#8b4513]">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-[#3e1f0a]">Data Transaksi</h2>
                        <p class="text-xs text-gray-400 mt-1">Gunakan filter untuk menyaring data</p>
                    </div>
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 mb-1">DARI TANGGAL</label>
                            <input type="date" id="filter-start" class="border border-gray-200 p-2 rounded text-xs outline-none" onchange="renderLaporan()">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 mb-1">SAMPAI TANGGAL</label>
                            <input type="date" id="filter-end" class="border border-gray-200 p-2 rounded text-xs outline-none" onchange="renderLaporan()">
                        </div>
                        <div class="flex items-end gap-2">
                             <button onclick="syncFromCloud()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs flex items-center gap-1 h-[34px]"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync Cloud</button>
                             <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs flex items-center gap-1 h-[34px]"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel</button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="table-transaksi">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-3">ID TRX</th>
                                <th class="p-3">Waktu</th>
                                <th class="p-3">Rincian</th>
                                <th class="p-3 text-right">Omzet</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Varian -->
    <div id="modal-varian" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl max-w-sm w-full">
            <div id="varian-foto-container" class="mb-4 hidden">
                <img id="varian-foto" src="" class="w-full h-40 object-cover rounded-lg">
            </div>
            <h3 id="varian-nama-produk" class="text-xl font-bold mb-4"></h3>
            <div class="grid gap-3">
                <button onclick="addVariantToCart('Reguler')" class="flex justify-between p-4 border rounded-xl hover:bg-gray-50">
                    <span>Reguler</span><span id="price-reg" class="font-bold"></span>
                </button>
                <button onclick="addVariantToCart('1 Liter')" class="flex justify-between p-4 border rounded-xl hover:bg-gray-50">
                    <span>1 Liter</span><span id="price-1l" class="font-bold"></span>
                </button>
            </div>
            <button onclick="closeVariantModal()" class="w-full mt-4 text-gray-400">Batal</button>
        </div>
    </div>

    <!-- Modal Cetak Struk -->
    <div id="modal-struk" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[60]">
        <div class="bg-white p-4 rounded-xl max-w-fit flex flex-col items-center">
            <div id="receipt-modal-content">
                <div id="receipt-content">
                    <!-- Dinamis diisi JS -->
                </div>
            </div>
            <div class="flex gap-2 mt-6 no-print-receipt">
                <button onclick="downloadReceipt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> PNG
                </button>
                <button onclick="window.print()" class="bg-[#8b4513] text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print
                </button>
                <button onclick="closeReceiptModal()" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-lg font-bold">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        const defaultURL = "https://script.google.com/macros/s/AKfycbyjvYYpUTRjUzzbjAFXFwIHb9b9miXC8pK6eDAwimbpGtno2Uc_tSrvJEBxjHQlfWPP/exec";
        let scriptURL = localStorage.getItem('google_script_url') || defaultURL;
        document.getElementById('config-url').value = scriptURL;

        let dbMenu = JSON.parse(localStorage.getItem('kasir_menu_cloud')) || [
            { id: 1, nama: 'Hening Aren', foto: 'https://th.bing.com/th/id/OIP.fAgRcm6uBRmF6cqob-lzEAHaEJ?w=284&h=180&c=7&r=0&o=7&cb=defcache2&pid=1.7&rm=3&defcache=1', variants: { 'Reguler': { harga: 12000, hpp: 8570 }, '1 Liter': { harga: 70000, hpp: 35000 } } },
            { id: 2, nama: 'Salted Caramel', foto: 'https://th.bing.com/th/id/OIP.fC2bHmjOiOGPLodAY_AXagHaNM?w=187&h=333&c=7&r=0&o=7&cb=defcache2&pid=1.7&rm=3&defcache=1', variants: { 'Reguler': { harga: 13000, hpp: 9175 }, '1 Liter': { harga: 75000, hpp: 36000 } } },
            { id: 3, nama: 'Butterscotch', foto: 'https://tse3.mm.bing.net/th/id/OIP.c-Anyi2aOmIaCk7oGG33ugHaHa?cb=defcache2defcache=1&w=1024&h=1024&rs=1&pid=ImgDetMain&o=7&rm=3', variants: { 'Reguler': { harga: 13000, hpp: 9175 }, '1 Liter': { harga: 75000, hpp: 36000 } } },
            { id: 4, nama: 'Vanilla Latte', foto: 'https://images.rawpixel.com/image_social_landscape/cHJpdmF0ZS9sci9pbWFnZXMvd2Vic2l0ZS8yMDIzLTA5L3Jhd3BpeGVsX29mZmljZV8yM19pY2VfbGF0dGVfaW5fY2xlYXJfZ2xhc3NfY3VwX2luX3RoZV9jYWZlX2Flc181ZjE3YWQ2ZC1lNGQwLTRlZGItYmM1NC0zODg4NTVmZjRiN2ZfMS5qcGc.jpg', variants: { 'Reguler': { harga: 13000, hpp: 9175 }, '1 Liter': { harga: 75000, hpp: 36000 } } },
            { id: 5, nama: 'Americano', foto: 'https://image.freepik.com/free-photo/espresso-tonic-with-tonic-water-coffee-ice_132278-2578.jpg', variants: { 'Reguler': { harga: 10000, hpp: 4680 }, '1 Liter': { harga: 55000, hpp: 19400 } } },
            { id: 6, nama: 'Matcha Latte', foto: 'https://leparisfrenchbakery.com/wp-content/uploads/2024/06/Iced-Matcha-Latte.jpg', variants: { 'Reguler': { harga: 18000, hpp: 8000 }, '1 Liter': { harga: 60000, hpp: 28000 } } },
            { id: 7, nama: 'Chocolate Signature', foto: 'https://th.bing.com/th/id/OIP.W2khoxZ6VKxdyt4M-ihiVQHaDs?w=323&h=174&c=7&r=0&o=7&cb=defcache2&pid=1.7&rm=3&defcache=1', variants: { 'Reguler': { harga: 18000, hpp: 8000 }, '1 Liter': { harga: 60000, hpp: 28000 } } }
        ];
        let riwayatTransaksi = JSON.parse(localStorage.getItem('kasir_transaksi_cloud')) || [];
        let keranjang = [];
        let activeProductForModal = null;

        function saveConfig() {
            scriptURL = document.getElementById('config-url').value.trim();
            localStorage.setItem('google_script_url', scriptURL);
            updateStatus();
        }

        function updateStatus() {
            const el = document.getElementById('status-cloud');
            if (scriptURL && scriptURL.includes('google.com')) {
                el.innerHTML = `Status: <span class="text-green-600">Cloud Connected ✔</span>`;
                el.className = "mb-4 text-center text-xs font-bold py-1 rounded border border-green-200 bg-green-50";
            } else {
                el.innerHTML = `Status: Standalone Mode`;
                el.className = "mb-4 text-center text-xs font-bold text-gray-500 bg-gray-100 py-1 rounded border border-gray-200";
            }
        }

        function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

        // --- KASIR & CART LOGIC ---
        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const search = document.getElementById('search-menu').value.toLowerCase();
            dbMenu.filter(m => m.nama.toLowerCase().includes(search)).forEach(item => {
                const card = document.createElement('div');
                card.className = 'menu-card bg-white p-3 rounded-xl shadow-sm cursor-pointer border border-[#f5e6d3] flex flex-col';
                card.onclick = () => openVariantModal(item);
                
                const img = item.foto ? `<img src="${item.foto}">` : `<div class="h-[120px] bg-gray-100 rounded-lg mb-2 flex items-center justify-center text-gray-300"><i data-lucide="image"></i></div>`;
                
                const hargaReg = item.variants['Reguler']?.harga || 0;
                const harga1L = item.variants['1 Liter']?.harga || 0;

                card.innerHTML = `
                    ${img}
                    <h4 class="font-bold text-[#3e1f0a] text-sm truncate mb-1">${item.nama}</h4>
                    <div class="mt-auto space-y-1">
                        <div class="flex justify-between items-center text-[10px] bg-[#fdfaf7] px-2 py-1 rounded border border-[#f5e6d3]">
                            <span class="text-gray-500">Reg:</span>
                            <span class="text-[#8b4513] font-bold text-[11px]">Rp ${hargaReg.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px] bg-[#fff9f2] px-2 py-1 rounded border border-[#ffe4c4]">
                            <span class="text-gray-500">1L:</span>
                            <span class="text-[#a0522d] font-bold text-[11px]">Rp ${harga1L.toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            if(window.lucide) lucide.createIcons();
        }

        function openVariantModal(item) {
            activeProductForModal = item;
            document.getElementById('varian-nama-produk').innerText = item.nama;
            const fC = document.getElementById('varian-foto-container');
            const fI = document.getElementById('varian-foto');
            if(item.foto) { fI.src = item.foto; fC.classList.remove('hidden'); } else { fC.classList.add('hidden'); }
            document.getElementById('price-reg').innerText = 'Rp ' + (item.variants['Reguler']?.harga || 0).toLocaleString('id-ID');
            document.getElementById('price-1l').innerText = 'Rp ' + (item.variants['1 Liter']?.harga || 0).toLocaleString('id-ID');
            document.getElementById('modal-varian').classList.remove('hidden');
        }

        function addVariantToCart(v) {
            const variant = activeProductForModal.variants[v];
            const cartId = activeProductForModal.id + v;
            const exists = keranjang.find(k => k.cartId === cartId);
            if(exists) exists.qty++;
            else keranjang.push({ cartId, nama: activeProductForModal.nama, varian: v, harga: variant.harga, hpp: variant.hpp, qty: 1 });
            updateCartUI();
            closeVariantModal();
        }

        function changeQty(index, delta) {
            keranjang[index].qty += delta;
            if(keranjang[index].qty <= 0) keranjang.splice(index, 1);
            updateCartUI();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            if (!container) return;
            container.innerHTML = '';
            let total = 0;
            if(keranjang.length === 0) container.innerHTML = '<p class="text-gray-400 text-center py-4 italic text-sm">Belum ada pesanan</p>';
            keranjang.forEach((item, i) => {
                total += item.harga * item.qty;
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-[#fdfaf7] p-2 rounded border border-[#f5e6d3]">
                        <div class="flex-1">
                            <p class="font-bold text-[#3e1f0a] text-xs">${item.nama}</p>
                            <p class="text-[9px] text-gray-500">${item.varian} • Rp ${item.harga.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex items-center border border-[#d2b48c] rounded-lg bg-white overflow-hidden">
                                <button onclick="changeQty(${i}, -1)" class="px-2 py-1 hover:bg-gray-100 text-[#8b4513] font-bold">-</button>
                                <span class="px-2 text-xs font-bold">${item.qty}</span>
                                <button onclick="changeQty(${i}, 1)" class="px-2 py-1 hover:bg-gray-100 text-[#8b4513] font-bold">+</button>
                            </div>
                            <b class="text-[#8b4513] text-xs min-w-[60px] text-right">Rp ${(item.harga*item.qty).toLocaleString('id-ID')}</b>
                        </div>
                    </div>`;
            });
            document.getElementById('cart-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // --- ADMIN / EDIT LOGIC ---
        document.getElementById('menu-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('menu-id').value;
            const menuData = {
                id: id ? parseInt(id) : Date.now(),
                nama: document.getElementById('menu-nama').value,
                foto: document.getElementById('menu-foto').value,
                variants: {
                    'Reguler': { harga: parseInt(document.getElementById('menu-harga-reg').value) || 0, hpp: parseInt(document.getElementById('menu-hpp-reg').value) || 0 },
                    '1 Liter': { harga: parseInt(document.getElementById('menu-harga-1l').value) || 0, hpp: parseInt(document.getElementById('menu-hpp-1l').value) || 0 }
                }
            };

            if(id) {
                const idx = dbMenu.findIndex(m => m.id == id);
                dbMenu[idx] = menuData;
            } else {
                dbMenu.push(menuData);
            }

            localStorage.setItem('kasir_menu_cloud', JSON.stringify(dbMenu));
            resetMenuForm();
            renderMenu();
            renderAdminList();
            alert("Berhasil disimpan!");
        };

        function editMenu(id) {
            const item = dbMenu.find(m => m.id == id);
            if(!item) return;
            document.getElementById('form-title').innerText = "Edit Menu";
            document.getElementById('menu-id').value = item.id;
            document.getElementById('menu-nama').value = item.nama;
            document.getElementById('menu-foto').value = item.foto || '';
            document.getElementById('menu-harga-reg').value = item.variants['Reguler']?.harga || 0;
            document.getElementById('menu-hpp-reg').value = item.variants['Reguler']?.hpp || 0;
            document.getElementById('menu-harga-1l').value = item.variants['1 Liter']?.harga || 0;
            document.getElementById('menu-hpp-1l').value = item.variants['1 Liter']?.hpp || 0;
            
            document.getElementById('btn-submit-menu').innerText = "Update Produk";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('menu-form').scrollIntoView({ behavior: 'smooth' });
        }

        function resetMenuForm() {
            document.getElementById('menu-form').reset();
            document.getElementById('menu-id').value = '';
            document.getElementById('form-title').innerText = "Tambah Menu Baru";
            document.getElementById('btn-submit-menu').innerText = "Simpan Produk";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function renderAdminList() {
            const list = document.getElementById('admin-menu-list');
            if (!list) return;
            list.innerHTML = '<h3 class="font-bold text-[#3e1f0a] mb-2 mt-4">Daftar Produk Aktif</h3>';
            dbMenu.forEach(m => {
                list.innerHTML += `
                    <div class="p-2 bg-[#fdfaf7] border border-[#d2b48c] rounded-lg flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="${m.foto || 'https://via.placeholder.com/50'}" class="w-10 h-10 object-cover rounded">
                            <div>
                                <p class="font-semibold text-xs text-[#5d2e0d]">${m.nama}</p>
                                <p class="text-[9px] text-gray-400">Rp ${m.variants['Reguler']?.harga.toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editMenu(${m.id})" class="text-blue-500 p-2 hover:bg-blue-50 rounded-full transition">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteMenu(${m.id})" class="text-red-500 p-2 hover:bg-red-50 rounded-full transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
            });
            if(window.lucide) lucide.createIcons();
        }

        // --- STRUK LOGIC ---
        function generateReceiptHTML(trx) {
            const date = new Date(trx.waktu).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
            let itemsHTML = '';
            
            // Cek apakah item aslinya ada (jika ini dari keranjang saat ini) atau rincian teks (jika dari riwayat)
            if(trx.items) {
                trx.items.forEach(it => {
                    itemsHTML += `
                        <div style="display: flex; justify-between; margin-bottom: 2px;">
                            <div style="flex: 1;">${it.nama} (${it.varian})<br>x${it.qty} @${it.harga.toLocaleString()}</div>
                            <div style="text-align: right;">${(it.harga*it.qty).toLocaleString()}</div>
                        </div>`;
                });
            } else {
                itemsHTML = `<div style="margin-bottom: 10px;">${trx.rincian}</div>`;
            }

            return `
                <div style="text-align: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; font-size: 16px;">TITIK HENING</h2>
                    <p style="margin: 5px 0; font-size: 10px;">Jakarta Utara<br>WhatsApp: 0813-9843-4149</p>
                    <div style="border-bottom: 1px dashed black; margin: 10px 0;"></div>
                    <p style="margin: 0; font-size: 9px; text-align: left;">ID: ${trx.id}</p>
                    <p style="margin: 0; font-size: 9px; text-align: left;">Tgl: ${date}</p>
                    <div style="border-bottom: 1px dashed black; margin: 10px 0;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    ${itemsHTML}
                </div>
                <div style="border-bottom: 1px dashed black; margin: 10px 0;"></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                    <span>TOTAL</span>
                    <span>Rp ${(trx.total || trx.omzet).toLocaleString()}</span>
                </div>
                <div style="border-bottom: 1px dashed black; margin: 10px 0;"></div>
                <div style="text-align: center; margin-top: 20px; font-size: 10px;">
                    Terima Kasih Atas Kunjungan Anda<br>
                    Hanya Ada Anda, Kopi, dan Jeda.<br>
                    Follow IG @titikheningcoffee
                </div>
            `;
        }

        function showReceipt(trxId) {
            const trx = riwayatTransaksi.find(t => t.id === trxId);
            if(!trx) return;
            
            const container = document.getElementById('receipt-content');
            container.innerHTML = generateReceiptHTML(trx);
            document.getElementById('modal-struk').classList.remove('hidden');
            if(window.lucide) lucide.createIcons();
        }

        function closeReceiptModal() {
            document.getElementById('modal-struk').classList.add('hidden');
        }

        function downloadReceipt() {
            const element = document.getElementById('receipt-content');
            html2canvas(element, { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Struk_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- CLOUD SYNC ---
        async function syncFromCloud() {
            if (!scriptURL) return alert("URL Cloud belum diisi!");
            toggleLoader(true);
            try {
                const response = await fetch(`${scriptURL}?action=getTransactions`);
                const data = await response.json();
                riwayatTransaksi = data.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));
                localStorage.setItem('kasir_transaksi_cloud', JSON.stringify(riwayatTransaksi));
                renderLaporan();
                alert("Sinkronisasi Cloud Berhasil!");
            } catch (e) {
                alert("Gagal sinkronisasi. Pastikan URL Cloud benar.");
            } finally {
                toggleLoader(false);
            }
        }

        async function prosesPembayaran() {
            if(keranjang.length === 0) return;
            const total = keranjang.reduce((a,b) => a + (b.harga*b.qty), 0);
            const hpp = keranjang.reduce((a,b) => a + (b.hpp*b.qty), 0);
            const rincian = keranjang.map(i => `${i.nama} (${i.varian}) x${i.qty}`).join(', ');
            
            // Simpan copy item untuk struk yang akurat
            const itemsCopy = [...keranjang];

            const trx = { 
                id: 'TRX'+Date.now(), 
                waktu: new Date().toISOString(), 
                rincian, 
                items: itemsCopy,
                total, 
                totalHpp: hpp, 
                laba: total - hpp 
            };
            
            riwayatTransaksi.unshift(trx);
            localStorage.setItem('kasir_transaksi_cloud', JSON.stringify(riwayatTransaksi));
            
            if(scriptURL && scriptURL.includes('google.com')) {
                toggleLoader(true);
                try {
                    await fetch(scriptURL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify({ 
                            action: 'addTransaction', 
                            ...trx, 
                            omzet: total, 
                            modal: hpp 
                        }) 
                    });
                } catch(e) {} finally { setTimeout(() => toggleLoader(false), 500); }
            }
            
            // Tampilkan struk setelah pembayaran
            showReceipt(trx.id);

            keranjang = []; 
            updateCartUI(); 
        }

        // --- LAPORAN & EXCEL LOGIC ---
        function renderLaporan() {
            const body = document.getElementById('laporan-body');
            if (!body) return;
            body.innerHTML = '';
            
            let o=0, m=0, l=0;
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;

            const filteredData = riwayatTransaksi.filter(t => {
                if (!t.waktu) return false;
                const dateObj = new Date(t.waktu);
                if (isNaN(dateObj.getTime())) return false;
                
                const dateStr = dateObj.toISOString().split('T')[0];
                if(start && dateStr < start) return false;
                if(end && dateStr > end) return false;
                return true;
            });

            filteredData.forEach(t => {
                const omz = t.total || t.omzet || 0;
                const mod = t.totalHpp || t.modal || 0;
                const lab = t.laba || (omz - mod);
                o+=omz; m+=mod; l+=lab;
                
                body.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-[9px] font-bold text-gray-500">${t.id || '-'}</td>
                        <td class="p-3 text-[10px] whitespace-nowrap">${new Date(t.waktu).toLocaleString('id-ID')}</td>
                        <td class="p-3 text-xs max-w-[200px] truncate">${t.rincian || '-'}</td>
                        <td class="p-3 text-right">Rp ${omz.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            <button onclick="showReceipt('${t.id}')" class="text-[#8b4513] p-2 hover:bg-[#f5e6d3] rounded-full transition" title="Cetak Ulang Struk">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            document.getElementById('summary-omzet').innerText = 'Rp '+o.toLocaleString();
            document.getElementById('summary-modal').innerText = 'Rp '+m.toLocaleString();
            document.getElementById('summary-laba').innerText = 'Rp '+l.toLocaleString();
            if(window.lucide) lucide.createIcons();
        }

        function exportToExcel() {
            const start = document.getElementById('filter-start').value || 'Awal';
            const end = document.getElementById('filter-end').value || 'Akhir';
            
            const dataToExport = riwayatTransaksi.filter(t => {
                if (!t.waktu) return false;
                const dateObj = new Date(t.waktu);
                if (isNaN(dateObj.getTime())) return false;
                const dateStr = dateObj.toISOString().split('T')[0];
                if(start !== 'Awal' && dateStr < start) return false;
                if(end !== 'Akhir' && dateStr > end) return false;
                return true;
            }).map(t => ({
                'ID Transaksi': t.id || '-',
                'Waktu': new Date(t.waktu).toLocaleString('id-ID'),
                'Rincian Pesanan': t.rincian || '-',
                'Omzet (Penjualan)': t.total || t.omzet || 0,
                'HPP (Modal)': t.totalHpp || t.modal || 0,
                'Laba Bersih': t.laba || ((t.total||t.omzet) - (t.totalHpp||t.modal))
            }));

            if(dataToExport.length === 0) return alert("Tidak ada data untuk diekspor!");
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Penjualan");
            XLSX.writeFile(workbook, `Laporan_Kasir_${start}_sd_${end}.xlsx`);
        }

        function deleteMenu(id) { if(confirm("Hapus?")) { dbMenu = dbMenu.filter(m=>m.id!==id); localStorage.setItem('kasir_menu_cloud', JSON.stringify(dbMenu)); renderMenu(); renderAdminList(); } }
        
        function switchTab(t) { 
            ['kasir', 'admin', 'laporan'].forEach(id => {
                const el = document.getElementById('tab-' + id);
                if(el) el.classList.add('hidden');
            }); 
            const target = document.getElementById('tab-' + t);
            if(target) target.classList.remove('hidden'); 
            if(t==='laporan') renderLaporan(); 
            if(window.lucide) lucide.createIcons();
        }
        
        function closeVariantModal() { document.getElementById('modal-varian').classList.add('hidden'); }
        
        const searchInput = document.getElementById('search-menu');
        if(searchInput) searchInput.oninput = renderMenu;

        window.onload = () => { 
            renderMenu(); 
            renderAdminList(); 
            updateStatus(); 
            if(window.lucide) lucide.createIcons(); 
        };
    </script>
</body>
</html>
