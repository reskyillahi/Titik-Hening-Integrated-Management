<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kasir Pro - Google Sheets Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fdfaf7; }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .menu-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; background-color: #f5e6d3; }
        
        #receipt-content { 
            width: 300px; 
            background: white; 
            padding: 24px; 
            font-family: 'Courier Prime', monospace; 
            color: black; 
            font-size: 13px; 
            line-height: 1.2;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        .receipt-divider { border: 0; border-top: 1px dashed #000; margin: 10px 0; }
        .receipt-item { margin-bottom: 4px; }
        .receipt-header { text-align: center; margin-bottom: 15px; }
        .receipt-footer { text-align: center; margin-top: 15px; font-size: 11px; }

        @media print {
            body * { visibility: hidden; }
            #receipt-modal-content, #receipt-modal-content * { visibility: visible; }
            #receipt-modal-content { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print-receipt { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="loader" class="loading-overlay">
        <div class="bg-white p-6 rounded-xl flex items-center gap-4 shadow-2xl">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#8b4513]"></div>
            <p class="font-bold text-[#3e1f0a]" id="loader-text">Sinkronisasi Cloud...</p>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] pointer-events-none">
        <div id="toast" class="bg-red-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 font-semibold text-sm opacity-0 -translate-y-10 transition-all duration-300">
            <i data-lucide="alert-circle" class="w-4 h-4"></i>
            <span id="toast-msg">Notifikasi</span>
        </div>
    </div>

    <nav class="bg-[#5d2e0d] text-[#fdfaf7] p-4 shadow-lg no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="coffee"></i> TITIK HENING
            </h1>
            <div class="flex gap-2">
                <button onclick="switchTab('kasir')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm">Kasir</button>
                <button onclick="switchTab('admin')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm">Menu</button>
                <button onclick="switchTab('laporan')" class="hover:bg-[#8b4513] px-3 py-1 rounded transition text-sm">Laporan</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6 mb-20 no-print">
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div id="status-cloud" class="flex-1 text-center text-xs font-bold text-gray-500 bg-gray-100 py-2 rounded border border-gray-200">
                Status: Standalone Mode
            </div>
            <div id="wrapper-petugas" class="flex items-center gap-2 bg-white px-3 py-1 rounded border border-[#d2b48c] shadow-sm transition-all duration-300">
                <i data-lucide="user" class="w-4 h-4 text-[#8b4513]"></i>
                <input type="text" id="nama-petugas" placeholder="Nama Kasir" class="text-xs font-bold outline-none text-[#3e1f0a] w-32 bg-transparent" oninput="clearErrorPetugas()">
            </div>
        </div>

        <!-- TAB KASIR -->
        <div id="tab-kasir" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-[#3e1f0a]">Menu Pilihan</h2>
                    <div class="relative w-full md:w-1/3">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-[#8b4513]"></i>
                        <input type="text" id="search-menu" placeholder="Cari minuman..." class="border border-[#d2b48c] rounded-lg pl-10 pr-4 py-2 w-full text-sm outline-none bg-white" oninput="renderMenu()">
                    </div>
                </div>
                <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md h-fit sticky top-6 border-t-4 border-[#8b4513]">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-[#3e1f0a]">
                    <i data-lucide="shopping-cart"></i> Daftar Pesanan
                </h2>
                <div id="cart-items" class="space-y-4 mb-6 max-h-80 overflow-y-auto">
                    <p class="text-gray-400 text-center py-4 italic text-sm">Belum ada pesanan</p>
                </div>
                <div class="border-t border-[#f5e6d3] pt-4">
                    <div class="flex justify-between text-lg font-bold">
                        <span class="text-[#3e1f0a]">Total Akhir:</span>
                        <span id="cart-total" class="text-[#8b4513]">Rp 0</span>
                    </div>
                    <button onclick="handleCheckout()" class="w-full bg-[#8b4513] hover:bg-[#5d2e0d] text-white font-bold py-3 rounded-lg mt-4 transition shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="wallet"></i> Pilih Pembayaran
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB ADMIN -->
        <div id="tab-admin" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto border-t-4 border-[#8b4513]">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs text-yellow-700 font-bold uppercase tracking-wider">Cloud Database</p>
                        <div class="flex gap-2">
                            <button onclick="pullMenuFromCloud()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-[10px] font-bold flex items-center gap-1 shadow-sm">
                                <i data-lucide="download-cloud" class="w-3 h-3"></i> PULL MENU
                            </button>
                        </div>
                    </div>
                    <input type="text" id="config-url" placeholder="URL Web App Google Script" class="w-full border border-yellow-200 p-2 rounded text-[10px] bg-white outline-none focus:ring-1 focus:ring-yellow-400" onchange="saveConfig()">
                </div>
                
                <h2 id="form-title" class="text-xl font-bold mb-6 text-[#3e1f0a]">Manajemen Produk</h2>
                <form id="menu-form" class="space-y-4">
                    <input type="hidden" id="menu-id">
                    <input type="text" id="menu-nama" placeholder="Nama Produk" required class="w-full border border-[#d2b48c] rounded-lg px-4 py-2 outline-none">
                    <input type="text" id="menu-foto" placeholder="URL Foto Produk" class="w-full border border-[#d2b48c] rounded-lg px-4 py-2 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-[#fdfaf7] p-3 rounded-lg border border-[#d2b48c]">
                            <p class="font-bold text-[10px] text-[#8b4513] mb-2">VARIAN REGULER</p>
                            <input type="number" id="menu-harga-reg" placeholder="Harga Jual" class="w-full border border-[#d2b48c] rounded px-2 py-1 mb-2 text-sm">
                            <input type="number" id="menu-hpp-reg" placeholder="HPP (Modal)" class="w-full border border-[#d2b48c] rounded px-2 py-1 text-sm">
                        </div>
                        <div class="bg-[#fdfaf7] p-3 rounded-lg border border-[#d2b48c]">
                            <p class="font-bold text-[10px] text-[#8b4513] mb-2">VARIAN 1 LITER</p>
                            <input type="number" id="menu-harga-1l" placeholder="Harga Jual" class="w-full border border-[#d2b48c] rounded px-2 py-1 mb-2 text-sm">
                            <input type="number" id="menu-hpp-1l" placeholder="HPP (Modal)" class="w-full border border-[#d2b48c] rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="btn-submit-menu" class="flex-1 bg-[#8b4513] text-white py-2 rounded-lg font-bold">Simpan & Push ke Cloud</button>
                        <button type="button" id="btn-cancel-edit" onclick="resetMenuForm()" class="hidden bg-gray-200 text-gray-600 px-4 py-2 rounded-lg font-bold">Batal</button>
                    </div>
                </form>
                <div id="admin-menu-list" class="mt-8 space-y-2"></div>
            </div>
        </div>

        <!-- TAB LAPORAN -->
        <div id="tab-laporan" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-[#8b4513]">
                <h2 class="text-lg font-bold mb-4 text-[#3e1f0a] flex items-center gap-2">
                    <i data-lucide="filter" class="w-5 h-5"></i> Filter Periode
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Mulai Tanggal</label>
                        <input type="date" id="filter-date-start" class="w-full border border-[#d2b48c] rounded-lg px-3 py-2 text-sm outline-none" onchange="renderLaporan()">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Sampai Tanggal</label>
                        <input type="date" id="filter-date-end" class="w-full border border-[#d2b48c] rounded-lg px-3 py-2 text-sm outline-none" onchange="renderLaporan()">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resetFilterTanggal()" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-sm font-bold flex-1">Reset</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="syncFromCloud()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs flex items-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync Cloud</button>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Omzet Terfilter</p>
                    <h3 id="summary-omzet" class="text-xl font-bold">Rp 0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Modal Terfilter</p>
                    <h3 id="summary-modal" class="text-xl font-bold">Rp 0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Laba Terfilter</p>
                    <h3 id="summary-laba" class="text-xl font-bold text-green-700">Rp 0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-[#8b4513]">
                <h2 class="text-lg font-bold mb-4 text-[#3e1f0a]">Riwayat Transaksi</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="table-transaksi">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-3">ID TRX</th>
                                <th class="p-3">Waktu</th>
                                <th class="p-3">Kasir</th>
                                <th class="p-3">Metode</th>
                                <th class="p-3">Omzet</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="modal-bayar" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[55]">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-[#3e1f0a]">Pembayaran</h3>
            <p id="bayar-total-text" class="text-2xl font-black text-[#8b4513] mb-6">Rp 0</p>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="pilihMetode('Cash')" id="btn-metode-cash" class="flex flex-col items-center justify-center p-4 border-2 border-[#d2b48c] rounded-xl hover:bg-[#fdfaf7] transition">
                    <i data-lucide="banknote" class="w-8 h-8 mb-2 text-green-600"></i>
                    <span class="font-bold text-sm">Tunai (Cash)</span>
                </button>
                <button onclick="pilihMetode('QRIS')" id="btn-metode-qris" class="flex flex-col items-center justify-center p-4 border-2 border-[#d2b48c] rounded-xl hover:bg-[#fdfaf7] transition">
                    <i data-lucide="qr-code" class="w-8 h-8 mb-2 text-blue-600"></i>
                    <span class="font-bold text-sm">QRIS</span>
                </button>
            </div>
            <div id="input-tunai-container" class="hidden mb-6 space-y-3">
                <label class="text-xs font-bold text-gray-500 uppercase">Uang Diterima (Tunai)</label>
                <input type="number" id="uang-diterima" class="w-full text-xl font-bold border-b-2 border-[#8b4513] outline-none py-2 bg-transparent" placeholder="0" oninput="hitungKembalian()">
                <div class="flex justify-between text-sm pt-2">
                    <span class="text-gray-500">Kembalian:</span>
                    <span id="text-kembalian" class="font-bold text-red-600">Rp 0</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="tutupModalBayar()" class="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-500">Batal</button>
                <button id="btn-konfirmasi-bayar" onclick="prosesPembayaranFinal()" class="flex-[2] py-3 rounded-xl bg-[#8b4513] text-white font-bold shadow-lg opacity-50 cursor-not-allowed" disabled>Konfirmasi Bayar</button>
            </div>
        </div>
    </div>

    <div id="modal-varian" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl max-w-sm w-full">
            <h3 id="varian-nama-produk" class="text-xl font-bold mb-4"></h3>
            <div class="grid gap-3">
                <button onclick="addVariantToCart('Reguler')" class="flex justify-between p-4 border rounded-xl hover:bg-gray-50">
                    <span>Reguler</span><span id="price-reg" class="font-bold"></span>
                </button>
                <button onclick="addVariantToCart('1 Liter')" class="flex justify-between p-4 border rounded-xl hover:bg-gray-50">
                    <span>1 Liter</span><span id="price-1l" class="font-bold"></span>
                </button>
            </div>
            <button onclick="closeVariantModal()" class="w-full mt-4 text-gray-400 text-sm">Batal</button>
        </div>
    </div>

    <div id="modal-struk" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[60]">
        <div class="bg-white p-4 rounded-xl max-w-fit flex flex-col items-center">
            <div id="receipt-modal-content"><div id="receipt-content"></div></div>
            <div class="flex gap-2 mt-6 no-print-receipt">
                <button onclick="downloadReceipt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Simpan PNG</button>
                <button onclick="window.print()" class="bg-[#8b4513] text-white px-4 py-2 rounded-lg font-bold text-sm">Cetak Struk</button>
                <button onclick="closeReceiptModal()" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-lg font-bold text-sm">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        let scriptURL = localStorage.getItem('google_script_url') || "https://script.google.com/macros/s/AKfycbyHycPDYKotLWDNJoZO441hUkAUkT-f1QuwTmJtq9e9gSS9RZLOty0M4HUFZCFApVPN/exec";
        let dbMenu = JSON.parse(localStorage.getItem('kasir_menu_cloud')) || [];
        let riwayatTransaksi = JSON.parse(localStorage.getItem('kasir_transaksi_cloud')) || [];
        let keranjang = [];
        let activeProductForModal = null;
        let metodeTerpilih = "";
        let totalBelanja = 0;

        document.getElementById('config-url').value = scriptURL;
        document.getElementById('nama-petugas').value = localStorage.getItem('nama_petugas') || '';

        function showToast(msg, type = 'error') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = msg;
            toast.classList.toggle('bg-red-600', type === 'error');
            toast.classList.toggle('bg-green-600', type === 'success');
            toast.classList.remove('opacity-0', '-translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.replace('opacity-100', 'opacity-0');
                toast.classList.replace('translate-y-0', '-translate-y-10');
            }, 3000);
        }

        function clearErrorPetugas() {
            const wrapper = document.getElementById('wrapper-petugas');
            wrapper.classList.remove('shake', 'border-red-400');
            localStorage.setItem('nama_petugas', document.getElementById('nama-petugas').value);
        }

        function toggleLoader(show, text = "Sinkronisasi Cloud...") { 
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loader').style.display = show ? 'flex' : 'none'; 
        }

        function saveConfig() { 
            scriptURL = document.getElementById('config-url').value.trim(); 
            localStorage.setItem('google_script_url', scriptURL); 
            updateStatus();
        }

        function updateStatus() {
            const el = document.getElementById('status-cloud');
            if (scriptURL && scriptURL.includes('google.com')) {
                el.innerHTML = `Status: <span class="text-green-600 font-bold">Cloud Connected âœ”</span>`;
                el.className = "flex-1 text-center text-xs py-2 rounded border border-green-200 bg-green-50";
            } else {
                el.innerHTML = `Status: Standalone Mode`;
                el.className = "flex-1 text-center text-xs font-bold text-gray-500 bg-gray-100 py-2 rounded border border-gray-200";
            }
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            if(!grid) return;
            grid.innerHTML = '';
            const search = document.getElementById('search-menu').value.toLowerCase();
            dbMenu.filter(m => m.nama.toLowerCase().includes(search)).forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-card bg-white p-3 rounded-xl shadow-sm border border-[#f5e6d3] cursor-pointer hover:border-[#8b4513] transition';
                div.onclick = () => openVariantModal(item);
                div.innerHTML = `
                    <img src="${item.foto || 'https://via.placeholder.com/150'}">
                    <h4 class="font-bold text-[#3e1f0a] text-sm truncate">${item.nama}</h4>
                    <p class="text-[10px] text-gray-500">Mulai Rp ${item.variants['Reguler'].harga.toLocaleString('id-ID')}</p>
                `;
                grid.appendChild(div);
            });
            if (window.lucide) lucide.createIcons();
        }

        function openVariantModal(item) {
            activeProductForModal = item;
            document.getElementById('varian-nama-produk').innerText = item.nama;
            document.getElementById('price-reg').innerText = 'Rp ' + item.variants['Reguler'].harga.toLocaleString('id-ID');
            document.getElementById('price-1l').innerText = 'Rp ' + item.variants['1 Liter'].harga.toLocaleString('id-ID');
            document.getElementById('modal-varian').classList.remove('hidden');
        }

        function closeVariantModal() { document.getElementById('modal-varian').classList.add('hidden'); }

        function addVariantToCart(v) {
            const variant = activeProductForModal.variants[v];
            const cartId = activeProductForModal.id + v;
            const exists = keranjang.find(k => k.cartId === cartId);
            if(exists) exists.qty++;
            else keranjang.push({ cartId, nama: activeProductForModal.nama, varian: v, harga: variant.harga, hpp: variant.hpp, qty: 1 });
            updateCartUI(); closeVariantModal();
        }

        function changeQty(index, d) {
            keranjang[index].qty += d;
            if(keranjang[index].qty <= 0) keranjang.splice(index, 1);
            updateCartUI();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            if(keranjang.length === 0) container.innerHTML = '<p class="text-gray-400 text-center py-4 italic text-sm">Belum ada pesanan</p>';
            keranjang.forEach((item, i) => {
                total += item.harga * item.qty;
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-[#fdfaf7] p-2 rounded border border-[#f5e6d3] text-xs">
                        <div class="flex-1">
                            <p class="font-bold text-[#3e1f0a]">${item.nama} (${item.varian})</p>
                            <p class="text-[10px] text-gray-400">${item.qty} x Rp ${item.harga.toLocaleString()}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changeQty(${i},-1)" class="w-6 h-6 border rounded bg-white">-</button>
                            <span class="font-bold">${item.qty}</span>
                            <button onclick="changeQty(${i},1)" class="w-6 h-6 border rounded bg-white">+</button>
                        </div>
                    </div>`;
            });
            totalBelanja = total;
            document.getElementById('cart-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        function handleCheckout() {
            const namaPetugas = document.getElementById('nama-petugas');
            const wrapperPetugas = document.getElementById('wrapper-petugas');
            if (keranjang.length === 0) return showToast("Pilih menu terlebih dahulu!");
            if (!namaPetugas.value.trim()) {
                wrapperPetugas.classList.add('shake', 'border-red-400');
                namaPetugas.focus();
                showToast("Kasir belum diisi!");
                return;
            }
            bukaModalPembayaran();
        }

        function bukaModalPembayaran() {
            totalBelanja = keranjang.reduce((a,b) => a + (b.harga*b.qty), 0);
            document.getElementById('bayar-total-text').innerText = 'Rp ' + totalBelanja.toLocaleString('id-ID');
            document.getElementById('modal-bayar').classList.remove('hidden');
            metodeTerpilih = "";
            resetMetodeUI();
        }

        function tutupModalBayar() { document.getElementById('modal-bayar').classList.add('hidden'); }

        function pilihMetode(m) {
            metodeTerpilih = m;
            resetMetodeUI();
            const btnCash = document.getElementById('btn-metode-cash');
            const btnQris = document.getElementById('btn-metode-qris');
            const inputTunai = document.getElementById('input-tunai-container');
            const btnKonf = document.getElementById('btn-konfirmasi-bayar');
            if(m === 'Cash') {
                btnCash.classList.add('bg-[#8b4513]', 'text-white', 'border-[#8b4513]');
                inputTunai.classList.remove('hidden');
                document.getElementById('uang-diterima').focus();
            } else {
                btnQris.classList.add('bg-[#8b4513]', 'text-white', 'border-[#8b4513]');
                inputTunai.classList.add('hidden');
                btnKonf.disabled = false;
                btnKonf.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            if (window.lucide) lucide.createIcons();
        }

        function resetMetodeUI() {
            ['btn-metode-cash', 'btn-metode-qris'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('bg-[#8b4513]', 'text-white', 'border-[#8b4513]');
            });
            document.getElementById('btn-konfirmasi-bayar').disabled = true;
            document.getElementById('btn-konfirmasi-bayar').classList.add('opacity-50', 'cursor-not-allowed');
            if (window.lucide) lucide.createIcons();
        }

        function hitungKembalian() {
            const terima = parseInt(document.getElementById('uang-diterima').value) || 0;
            const kembali = terima - totalBelanja;
            document.getElementById('text-kembalian').innerText = 'Rp ' + (kembali < 0 ? 0 : kembali).toLocaleString('id-ID');
            const btnKonf = document.getElementById('btn-konfirmasi-bayar');
            if(terima >= totalBelanja) {
                btnKonf.disabled = false;
                btnKonf.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnKonf.disabled = true;
                btnKonf.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function prosesPembayaranFinal() {
            const petugas = document.getElementById('nama-petugas').value;
            const hpp = keranjang.reduce((a,b) => a + (b.hpp*b.qty), 0);
            const tunaiDiterima = parseInt(document.getElementById('uang-diterima').value) || 0;
            
            const trx = { 
                id: 'TRX'+Date.now(), waktu: new Date().toISOString(), petugas, 
                itemDetails: [...keranjang], metode: metodeTerpilih,
                diterima: metodeTerpilih === 'Cash' ? tunaiDiterima : totalBelanja,
                kembalian: metodeTerpilih === 'Cash' ? (tunaiDiterima - totalBelanja) : 0,
                omzet: totalBelanja, modal: hpp, laba: totalBelanja - hpp
            };
            
            riwayatTransaksi.unshift(trx);
            localStorage.setItem('kasir_transaksi_cloud', JSON.stringify(riwayatTransaksi));
            
            if(scriptURL) {
                toggleLoader(true, "Mencatat Transaksi...");
                try { await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addTransaction', ...trx }) }); } catch(e) {}
                finally { setTimeout(() => toggleLoader(false), 500); }
            }
            
            tutupModalBayar();
            showReceipt(trx);
            keranjang = []; updateCartUI();
        }

        function showReceipt(trx) {
            const date = new Date(trx.waktu);
            let itemsHTML = '';
            trx.itemDetails.forEach(item => {
                itemsHTML += `<div class="receipt-item"><div>${item.nama} (${item.varian})</div><div style="display:flex; justify-content:space-between; font-size:11px;"><span>${item.qty} x ${item.harga.toLocaleString()}</span><span>${(item.qty * item.harga).toLocaleString()}</span></div></div>`;
            });
            document.getElementById('receipt-content').innerHTML = `
                <div class="receipt-header">
                    <h2 style="margin:0; font-size:18px; font-weight:bold;">TITIK HENING</h2>
                    <p style="margin:2px 0; font-size:10px;">Hanya ada Anda, Kopi, dan Jeda</p>
                </div>
                <div style="font-size:10px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>ID: ${trx.id.slice(-6)}</span><span>${date.toLocaleDateString()}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Kasir: ${trx.petugas}</span><span>${date.toLocaleTimeString()}</span></div>
                </div>
                <hr class="receipt-divider">
                ${itemsHTML}
                <hr class="receipt-divider">
                <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>TOTAL</span><span>Rp ${trx.omzet.toLocaleString()}</span></div>
                <div style="font-size:11px; margin-top:5px;">
                    <div style="display:flex; justify-content:space-between;"><span>Metode:</span><span>${trx.metode}</span></div>
                    ${trx.metode === 'Cash' ? `<div style="display:flex; justify-content:space-between;"><span>Bayar:</span><span>Rp ${trx.diterima.toLocaleString()}</span></div><div style="display:flex; justify-content:space-between;"><span>Kembali:</span><span>Rp ${trx.kembalian.toLocaleString()}</span></div>` : ''}
                </div>
                <div class="receipt-footer">
                    <p style="margin:2px 0; font-size:10px;">Terima kasih atas kunjungannya</p>
                    <p style="margin:2px 0; font-size:10px; font-weight:bold">Follow IG @titikheningcoffee</p>
                </div>
            `;
            document.getElementById('modal-struk').classList.remove('hidden');
        }

        function resetFilterTanggal() {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            renderLaporan();
        }

        function renderLaporan() {
            const body = document.getElementById('laporan-body');
            if(!body) return;
            body.innerHTML = '';
            
            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            
            let filtered = [...riwayatTransaksi];

            if (start || end) {
                filtered = filtered.filter(t => {
                    const tDate = new Date(t.waktu).setHours(0,0,0,0);
                    const sDate = start ? new Date(start).setHours(0,0,0,0) : null;
                    const eDate = end ? new Date(end).setHours(0,0,0,0) : null;
                    
                    if (sDate && eDate) return tDate >= sDate && tDate <= eDate;
                    if (sDate) return tDate >= sDate;
                    if (eDate) return tDate <= eDate;
                    return true;
                });
            }

            let o=0, m=0, l=0;
            filtered.forEach(t => {
                o+=t.omzet; m+=t.modal; l+=t.laba;
                const methodIcon = t.metode === 'QRIS' ? '<span class="flex items-center gap-1 text-blue-600 font-bold"><i data-lucide="qr-code" class="w-3 h-3"></i> QRIS</span>' : '<span class="flex items-center gap-1 text-green-600 font-bold"><i data-lucide="banknote" class="w-3 h-3"></i> Tunai</span>';
                body.innerHTML += `<tr class="border-b text-[10px]"><td class="p-3 font-mono text-gray-500">#${String(t.id).slice(-6)}</td><td class="p-3">${new Date(t.waktu).toLocaleDateString()}</td><td class="p-3 uppercase font-bold">${t.petugas}</td><td class="p-3">${methodIcon}</td><td class="p-3 font-bold">Rp ${t.omzet.toLocaleString()}</td><td class="p-3 text-center"><button onclick='showReceipt(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="bg-[#fdfaf7] border border-[#d2b48c] px-3 py-1 rounded text-[#8b4513]">Struk</button></td></tr>`;
            });

            document.getElementById('summary-omzet').innerText = 'Rp '+o.toLocaleString();
            document.getElementById('summary-modal').innerText = 'Rp '+m.toLocaleString();
            document.getElementById('summary-laba').innerText = 'Rp '+l.toLocaleString();
            if (window.lucide) lucide.createIcons();
        }

        async function syncFromCloud() {
            if (!scriptURL) return showToast("URL Cloud belum diisi!");
            toggleLoader(true, "Sinkronisasi Transaksi...");
            try {
                const res = await fetch(`${scriptURL}?action=getTransactions`);
                const data = await res.json();
                if(Array.isArray(data)) {
                    riwayatTransaksi = data.map(item => ({
                        ...item,
                        omzet: Number(item.omzet || 0), modal: Number(item.modal || 0), laba: Number(item.laba || 0), waktu: item.waktu || new Date().toISOString()
                    })).sort((a,b) => new Date(b.waktu) - new Date(a.waktu));
                    localStorage.setItem('kasir_transaksi_cloud', JSON.stringify(riwayatTransaksi));
                    renderLaporan();
                    showToast("Laporan sinkron!", 'success');
                }
            } catch(e) { showToast("Gagal sinkron laporan."); }
            finally { toggleLoader(false); }
        }

        async function pushMenuToCloud() {
            if(!scriptURL) return;
            toggleLoader(true, "Sinkronisasi Menu ke Cloud...");
            try { await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveProducts', products: dbMenu }) }); } catch(e) {}
            finally { toggleLoader(false); }
        }

        async function pullMenuFromCloud() {
            if(!scriptURL) return showToast("URL Cloud belum diisi!");
            toggleLoader(true, "Mengambil Menu...");
            try {
                const res = await fetch(`${scriptURL}?action=getProducts`);
                const data = await res.json();
                if(Array.isArray(data)) {
                    dbMenu = data;
                    localStorage.setItem('kasir_menu_cloud', JSON.stringify(dbMenu));
                    renderMenu(); renderAdminList();
                    showToast("Menu ditarik!", 'success');
                }
            } catch(e) { showToast("Gagal tarik data."); }
            finally { toggleLoader(false); }
        }

        document.getElementById('menu-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('menu-id').value || Date.now();
            const newItem = {
                id: parseInt(id), nama: document.getElementById('menu-nama').value, foto: document.getElementById('menu-foto').value,
                variants: {
                    'Reguler': { harga: parseInt(document.getElementById('menu-harga-reg').value) || 0, hpp: parseInt(document.getElementById('menu-hpp-reg').value) || 0 },
                    '1 Liter': { harga: parseInt(document.getElementById('menu-harga-1l').value) || 0, hpp: parseInt(document.getElementById('menu-hpp-1l').value) || 0 }
                }
            };
            const idx = dbMenu.findIndex(m => m.id == id);
            if(idx > -1) dbMenu[idx] = newItem; else dbMenu.push(newItem);
            localStorage.setItem('kasir_menu_cloud', JSON.stringify(dbMenu));
            if (scriptURL) await pushMenuToCloud();
            resetMenuForm(); renderMenu(); renderAdminList();
            showToast("Menu disimpan!", 'success');
        };

        function resetMenuForm() {
            document.getElementById('menu-form').reset();
            document.getElementById('menu-id').value = '';
            document.getElementById('btn-submit-menu').innerText = "Simpan & Push ke Cloud";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function renderAdminList() {
            const list = document.getElementById('admin-menu-list');
            if(!list) return;
            list.innerHTML = '';
            dbMenu.forEach(m => {
                list.innerHTML += `<div class="p-3 bg-white border border-[#d2b48c] rounded-lg flex justify-between items-center text-xs"><span>${m.nama}</span><div class="flex gap-2"><button onclick="editMenu(${m.id})" class="text-blue-500 font-bold">Edit</button><button onclick="deleteMenu(${m.id})" class="text-red-500 font-bold">Hapus</button></div></div>`;
            });
        }

        function editMenu(id) {
            const m = dbMenu.find(item => item.id == id);
            if(!m) return;
            document.getElementById('menu-id').value = m.id;
            document.getElementById('menu-nama').value = m.nama;
            document.getElementById('menu-foto').value = m.foto || '';
            document.getElementById('menu-harga-reg').value = m.variants['Reguler'].harga;
            document.getElementById('menu-hpp-reg').value = m.variants['Reguler'].hpp;
            document.getElementById('menu-harga-1l').value = m.variants['1 Liter'].harga;
            document.getElementById('menu-hpp-1l').value = m.variants['1 Liter'].hpp;
            document.getElementById('btn-submit-menu').innerText = "Update & Push ke Cloud";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteMenu(id) { 
            if(confirm("Hapus produk ini?")) { 
                dbMenu = dbMenu.filter(m => m.id != id); 
                localStorage.setItem('kasir_menu_cloud', JSON.stringify(dbMenu)); 
                if (scriptURL) await pushMenuToCloud();
                renderMenu(); renderAdminList(); showToast("Produk dihapus.", 'success');
            } 
        }

        function switchTab(t) {
            ['kasir', 'admin', 'laporan'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(t==='laporan') renderLaporan();
            if(window.lucide) lucide.createIcons();
        }

        function exportToExcel() {
            if(riwayatTransaksi.length === 0) return showToast("Data kosong!");
            const worksheet = XLSX.utils.json_to_sheet(riwayatTransaksi);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan");
            XLSX.writeFile(workbook, `Laporan_${Date.now()}.xlsx`);
        }

        function closeReceiptModal() { document.getElementById('modal-struk').classList.add('hidden'); }
        function downloadReceipt() {
            html2canvas(document.getElementById('receipt-content'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = `Receipt_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
            });
        }
        window.onload = () => { renderMenu(); renderAdminList(); updateStatus(); if (window.lucide) lucide.createIcons(); };
    </script>
</body>
</html>
